
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../03-pipeflow/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.12">
    
    
      
        <title>Implementation - Parareal in Python</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.0d440cfe.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="pink" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#implementation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Parareal in Python" class="md-header__button md-logo" aria-label="Parareal in Python" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Parareal in Python
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Implementation
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="pink" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
            </label>
          
        
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="pink" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Parareal in Python" class="md-nav__button md-logo" aria-label="Parareal in Python" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Parareal in Python
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        About Parareal in Python
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../01-dho-simple/" class="md-nav__link">
        Tutorial: Dampened Harmonic Oscillator
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../02-dho-advanced/" class="md-nav__link">
        Tutorial: using HDF5 and MPI and Dask futures
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../03-pipeflow/" class="md-nav__link">
        03 pipeflow
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Implementation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Implementation
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#parareal" class="md-nav__link">
    Parareal
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-in-parallel" class="md-nav__link">
    Running in parallel
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dask-futures" class="md-nav__link">
    Dask futures
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#harmonic-oscillator" class="md-nav__link">
    Harmonic oscillator
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-figures" class="md-nav__link">
    Building figures
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#parareal" class="md-nav__link">
    Parareal
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-in-parallel" class="md-nav__link">
    Running in parallel
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dask-futures" class="md-nav__link">
    Dask futures
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#harmonic-oscillator" class="md-nav__link">
    Harmonic oscillator
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-figures" class="md-nav__link">
    Building figures
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="implementation">Implementation<a class="headerlink" href="#implementation" title="Permanent link">&para;</a></h1>
<div class="highlight"><pre><span></span><code><span class="c1"># file=&quot;parareal/__init__.py&quot;</span>
<span class="kn">import</span> <span class="nn">subprocess</span>

<span class="kn">from</span> <span class="nn">.tabulate_solution</span> <span class="kn">import</span> <span class="n">tabulate</span>
<span class="kn">from</span> <span class="nn">.parareal</span> <span class="kn">import</span> <span class="n">parareal</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">abstract</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;tabulate&quot;</span><span class="p">,</span> <span class="s2">&quot;parareal&quot;</span><span class="p">,</span> <span class="s2">&quot;schedule&quot;</span><span class="p">,</span> <span class="s2">&quot;abstract&quot;</span><span class="p">]</span>
</code></pre></div>
<h2 id="parareal">Parareal<a class="headerlink" href="#parareal" title="Permanent link">&para;</a></h2>
<p>From Wikipedia:</p>
<blockquote>
<p>Parareal solves an initial value problem of the form</p>
<div class="arithmatex">\[\dot{y}(t) = f(y(t), t), \quad y(t_0) = y_0 \quad \text{with} \quad t_0 \leq t \leq T.\]</div>
<p>Here, the right hand side <span class="arithmatex">\(f\)</span> can correspond to the spatial discretization of a partial differential equation in a method of lines approach.
Parareal now requires a decomposition of the time interval <span class="arithmatex">\([t_0, T]\)</span> into <span class="arithmatex">\(P\)</span> so-called time slices <span class="arithmatex">\([t_j, t_{j+1}]\)</span> such that</p>
<div class="arithmatex">\[[t_0, T] = [t_0, t_1] \cup [t_1, t_2] \cup \ldots \cup [t_{P-1}, t_{P} ].\]</div>
<p>Each time slice is assigned to one processing unit when parallelizing the algorithm, so that <span class="arithmatex">\(P\)</span> is equal to the number of processing units used for Parareal.</p>
<p>Parareal is based on the iterative application of two methods for integration of ordinary differential equations. One, commonly labelled <span class="arithmatex">\({\mathcal {F}}\)</span>, should be of high accuracy and computational cost while the other, typically labelled <span class="arithmatex">\({\mathcal {G}}\)</span>, must be computationally cheap but can be much less accurate. Typically, some form of Runge-Kutta method is chosen for both coarse and fine integrator, where <span class="arithmatex">\({\mathcal {G}}\)</span> might be of lower order and use a larger time step than <span class="arithmatex">\({\mathcal {F}}\)</span>. If the initial value problem stems from the discretization of a PDE, <span class="arithmatex">\({\mathcal {G}}\)</span> can also use a coarser spatial discretization, but this can negatively impact convergence unless high order interpolation is used. The result of numerical integration with one of these methods over a time slice <span class="arithmatex">\([t_{j}, t_{j+1}]\)</span> for some starting value <span class="arithmatex">\(y_{j}\)</span> given at <span class="arithmatex">\(t_{j}\)</span> is then written as</p>
<div class="arithmatex">\[y = \mathcal{F}(y_j, t_j, t_{j+1})\ {\rm or}\ y = \mathcal{G}(y_j, t_j, t_{j+1}).\]</div>
<p>Serial time integration with the fine method would then correspond to a step-by-step computation of</p>
<div class="arithmatex">\[y_{j+1} = \mathcal{F}(y_j, t_j, t_{j+1}), \quad j=0, \ldots, P-1.\]</div>
<p>Parareal instead uses the following iteration</p>
<div class="arithmatex">\[y_{j+1}^{k+1} = \mathcal{G}(y^{k+1}_j, t_j, t_{j+1}) + \mathcal{F}(y^k_j, t_j, t_{j+1}) - \mathcal{G}(y^k_j, t_j, t_{j+1}),\\ \quad j=0, \ldots, P-1, \quad k=0, \ldots, K-1,\]</div>
<p>where <span class="arithmatex">\(k\)</span> is the iteration counter. As the iteration converges and <span class="arithmatex">\(y^{k+1}_j - y^k_j \to 0\)</span>, the terms from the coarse method cancel out and Parareal reproduces the solution that is obtained by the serial execution of the fine method only. It can be shown that Parareal converges after a maximum of <span class="arithmatex">\(P\)</span> iterations. For Parareal to provide speedup, however, it has to converge in a number of iterations significantly smaller than the number of time slices, that is <span class="arithmatex">\(K \ll P\)</span>.</p>
<p>In the Parareal iteration, the computationally expensive evaluation of <span class="arithmatex">\(\mathcal{F}(y^k_j, t_j, t_{j+1})\)</span> can be performed in parallel on <span class="arithmatex">\(P\)</span> processing units. By contrast, the dependency of <span class="arithmatex">\(y^{k+1}_{j+1}\)</span> on <span class="arithmatex">\(\mathcal{G}(y^{k+1}_j, t_j, t_{j+1})\)</span> means that the coarse correction has to be computed in serial order.</p>
</blockquote>
<p>Don't get blinded by the details of the algorithm. After all, everything boils down to an update equation that uses a state vector <span class="arithmatex">\(y\)</span> to calculate the state at the immediately next future step (in the same fashion as equation +@eq:euler-method did). The core equation translates to:</p>
<div class="highlight"><span class="filename">#parareal-core-1</span><pre><span></span><code><span class="n">y_n</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">coarse</span><span class="p">(</span><span class="n">y_n</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> \
       <span class="o">+</span> <span class="n">fine</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> \
       <span class="o">-</span> <span class="n">coarse</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</code></pre></div>
<p>If we include a <code>Mapping</code> between fine and coarse meshes into the equation, we get:</p>
<div class="highlight"><span class="filename">#parareal-core-2</span><pre><span></span><code><span class="n">y_n</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">c2f</span><span class="p">(</span><span class="n">coarse</span><span class="p">(</span><span class="n">f2c</span><span class="p">(</span><span class="n">y_n</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> \
       <span class="o">+</span> <span class="n">fine</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> \
       <span class="o">-</span> <span class="n">c2f</span><span class="p">(</span><span class="n">coarse</span><span class="p">(</span><span class="n">f2c</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
</code></pre></div>
<p>The rest is boiler plate. For the <code>c2f</code> and <code>f2c</code> mappings we provide a default argument of the identity function.</p>
<div class="highlight"><span class="filename">parareal/parareal.py</span><pre><span></span><code><span class="kn">from</span> <span class="nn">.abstract</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Solution</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">identity</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">parareal</span><span class="p">(</span>
        <span class="n">coarse</span><span class="p">:</span> <span class="n">Solution</span><span class="p">,</span>
        <span class="n">fine</span><span class="p">:</span> <span class="n">Solution</span><span class="p">,</span>
        <span class="n">c2f</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">=</span> <span class="n">identity</span><span class="p">,</span>
        <span class="n">f2c</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">=</span> <span class="n">identity</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">size</span>
        <span class="n">y_n</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span>
        <span class="n">y_n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
            <span class="o">&lt;&lt;</span><span class="n">parareal</span><span class="o">-</span><span class="n">core</span><span class="o">-</span><span class="mi">2</span><span class="o">&gt;&gt;</span>
        <span class="k">return</span> <span class="n">y_n</span>
    <span class="k">return</span> <span class="n">f</span>

<span class="k">def</span> <span class="nf">parareal_np</span><span class="p">(</span>
        <span class="n">coarse</span><span class="p">:</span> <span class="n">Solution</span><span class="p">,</span>
        <span class="n">fine</span><span class="p">:</span> <span class="n">Solution</span><span class="p">,</span>
        <span class="n">c2f</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">=</span> <span class="n">identity</span><span class="p">,</span>
        <span class="n">f2c</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">=</span> <span class="n">identity</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">size</span>
        <span class="n">y_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">y_n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
            <span class="o">&lt;&lt;</span><span class="n">parareal</span><span class="o">-</span><span class="n">core</span><span class="o">-</span><span class="mi">2</span><span class="o">&gt;&gt;</span>
        <span class="k">return</span> <span class="n">y_n</span>
    <span class="k">return</span> <span class="n">f</span>
</code></pre></div>
<h2 id="running-in-parallel">Running in parallel<a class="headerlink" href="#running-in-parallel" title="Permanent link">&para;</a></h2>
<div class="highlight"><span class="filename">#import-dask</span><pre><span></span><code><span class="kn">from</span> <span class="nn">dask</span> <span class="kn">import</span> <span class="n">delayed</span>  <span class="c1"># type: ignore</span>
</code></pre></div>
<div class="highlight"><span class="filename">#daskify</span><pre><span></span><code><span class="o">&lt;&lt;</span><span class="n">import</span><span class="o">-</span><span class="n">dask</span><span class="o">&gt;&gt;</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">pintFoam.parareal.harmonic_oscillator</span> <span class="kn">import</span> \
    <span class="p">(</span> <span class="n">harmonic_oscillator</span><span class="p">,</span> <span class="n">underdamped_solution</span> <span class="p">)</span>
<span class="kn">from</span> <span class="nn">pintFoam.parareal.forward_euler</span> <span class="kn">import</span> \
    <span class="p">(</span> <span class="n">forward_euler</span> <span class="p">)</span>
<span class="kn">from</span> <span class="nn">pintFoam.parareal.tabulate_solution</span> <span class="kn">import</span> \
    <span class="p">(</span> <span class="n">tabulate</span> <span class="p">)</span>
<span class="kn">from</span> <span class="nn">pintFoam.parareal.parareal</span> <span class="kn">import</span> \
    <span class="p">(</span> <span class="n">parareal</span> <span class="p">)</span>
<span class="kn">from</span> <span class="nn">pintFoam.parareal.iterate_solution</span> <span class="kn">import</span> \
    <span class="p">(</span> <span class="n">iterate_solution</span><span class="p">)</span>


<span class="n">attrs</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">def</span> <span class="nf">green</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">greened</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="n">attrs</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fillcolor&quot;</span><span class="p">:</span> <span class="s2">&quot;#8888cc&quot;</span><span class="p">,</span> <span class="s2">&quot;style&quot;</span><span class="p">:</span> <span class="s2">&quot;filled&quot;</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">node</span>
    <span class="k">return</span> <span class="n">greened</span>

<span class="nd">@delayed</span>
<span class="k">def</span> <span class="nf">gather</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</code></pre></div>
<p>To see what Dask does, first we'll daskify the direct integration routine in <code>tabulate</code>. We take the same harmonic oscillator we had before. For the sake of argument let's divide the time line in three steps (so four points).</p>
<div class="highlight"><span class="filename">#daskify</span><pre><span></span><code><span class="n">omega_0</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">zeta</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">harmonic_oscillator</span><span class="p">(</span><span class="n">omega_0</span><span class="p">,</span> <span class="n">zeta</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">15.0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</code></pre></div>
<p>We now define the <code>fine</code> integrator:</p>
<div class="highlight"><span class="filename">#daskify</span><pre><span></span><code><span class="n">h</span> <span class="o">=</span> <span class="mf">0.01</span>

<span class="nd">@green</span>
<span class="nd">@delayed</span>
<span class="k">def</span> <span class="nf">fine</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t_0</span><span class="p">,</span> <span class="n">t_1</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">iterate_solution</span><span class="p">(</span><span class="n">forward_euler</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">h</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span> <span class="n">t_0</span><span class="p">,</span> <span class="n">t_1</span><span class="p">)</span>
</code></pre></div>
<p>It doesn't really matter what the fine integrator does, since we won't run anything. We'll just pretend. The <code>delayed</code> decorator makes sure that the integrator is never called, we just store the information that we <em>want</em> to call the <code>fine</code> function. The resulting value is a <em>promise</em> that at some point we <em>will</em> call the <code>fine</code> function. The nice thing is, that this promise behaves like any other Python object, it even qualifies as a <code>Vector</code>! The <code>tabulate</code> routine returns a <code>Sequence</code> of <code>Vector</code>s, in this case a list of promises. The <code>gather</code> function takes a list of promises and turns it into a promise of a list.</p>
<div class="highlight"><span class="filename">#daskify</span><pre><span></span><code><span class="n">y_euler</span> <span class="o">=</span> <span class="n">tabulate</span><span class="p">(</span><span class="n">fine</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">t</span><span class="p">)</span>
</code></pre></div>
<p>We can draw the resulting workflow:</p>
<div class="highlight"><span class="filename">build/plot-dask-seq.py</span><pre><span></span><code><span class="o">&lt;&lt;</span><span class="n">daskify</span><span class="o">&gt;&gt;</span>

<span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">y_euler</span><span class="p">)</span><span class="o">.</span><span class="n">visualize</span><span class="p">(</span><span class="s2">&quot;docs/img/seq-graph.svg&quot;</span><span class="p">,</span> <span class="n">rankdir</span><span class="o">=</span><span class="s2">&quot;LR&quot;</span><span class="p">,</span> <span class="n">data_attributes</span><span class="o">=</span><span class="n">attrs</span><span class="p">)</span>
</code></pre></div>
<div class="figure highlight"><pre><span></span><code><span class="err">Sequential</span><span class="w"> </span><span class="err">integration</span>
<span class="err">---</span>
<span class="nf">$(target)</span><span class="o">:</span><span class="w"> </span><span class="n">build</span>/<span class="n">plot</span>-<span class="n">dask</span>-<span class="n">seq</span>.<span class="n">py</span>
<span class="err">&gt;</span><span class="w"> </span><span class="err">@mkdir</span><span class="w"> </span><span class="err">-p</span><span class="w"> </span><span class="k">$(</span>@<span class="nv">D</span><span class="k">)</span>
<span class="err">&gt;</span><span class="w"> </span><span class="err">python</span><span class="w"> </span><span class="k">$&lt;</span>
</code></pre></div>
<p>This workflow is entirely sequential, every step depending on the preceding one. Now for Parareal! We also define the <code>coarse</code> integrator.</p>
<div class="highlight"><span class="filename">#daskify</span><pre><span></span><code><span class="nd">@delayed</span>
<span class="k">def</span> <span class="nf">coarse</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t_0</span><span class="p">,</span> <span class="n">t_1</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">forward_euler</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span> <span class="n">t_0</span><span class="p">,</span> <span class="n">t_1</span><span class="p">)</span>
</code></pre></div>
<p>Parareal is initialised with the ODE integrated by the coarse integrator, just like we did before with the fine one.</p>
<div class="highlight"><span class="filename">#daskify</span><pre><span></span><code><span class="n">y_first</span> <span class="o">=</span> <span class="n">tabulate</span><span class="p">(</span><span class="n">coarse</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">t</span><span class="p">)</span>
</code></pre></div>
<p>We can now perform a single iteration of Parareal to see what the workflow looks like:</p>
<div class="highlight"><span class="filename">#daskify</span><pre><span></span><code><span class="n">y_parareal</span> <span class="o">=</span> <span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">parareal</span><span class="p">(</span><span class="n">coarse</span><span class="p">,</span> <span class="n">fine</span><span class="p">)(</span><span class="n">y_first</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
</code></pre></div>
<div class="highlight"><span class="filename">build/plot-dask-graphs.py</span><pre><span></span><code><span class="o">&lt;&lt;</span><span class="n">daskify</span><span class="o">&gt;&gt;</span>

<span class="n">y_parareal</span><span class="o">.</span><span class="n">visualize</span><span class="p">(</span><span class="s2">&quot;docs/img/parareal-graph.svg&quot;</span><span class="p">,</span> <span class="n">rankdir</span><span class="o">=</span><span class="s2">&quot;LR&quot;</span><span class="p">,</span> <span class="n">data_attributes</span><span class="o">=</span><span class="n">attrs</span><span class="p">)</span>
</code></pre></div>
<div class="figure highlight"><pre><span></span><code><span class="err">Parareal</span><span class="w"> </span><span class="err">iteration;</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">fine</span><span class="w"> </span><span class="err">integrators</span><span class="w"> </span><span class="err">(marked</span><span class="w"> </span><span class="err">with</span><span class="w"> </span><span class="err">blue</span><span class="w"> </span><span class="err">squares)</span><span class="w"> </span><span class="err">can</span><span class="w"> </span><span class="err">be</span><span class="w"> </span><span class="err">run</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="err">parallel.</span>
<span class="err">---</span>
<span class="nf">$(target)</span><span class="o">:</span><span class="w"> </span><span class="n">build</span>/<span class="n">plot</span>-<span class="n">dask</span>-<span class="n">graphs</span>.<span class="n">py</span>
<span class="err">&gt;</span><span class="w"> </span><span class="err">@mkdir</span><span class="w"> </span><span class="err">-p</span><span class="w"> </span><span class="k">$(</span>@<span class="nv">D</span><span class="k">)</span>
<span class="err">&gt;</span><span class="w"> </span><span class="err">python</span><span class="w"> </span><span class="k">$&lt;</span>
</code></pre></div>
<h2 id="dask-futures">Dask futures<a class="headerlink" href="#dask-futures" title="Permanent link">&para;</a></h2>
<p>We reimplement Parareal in the <code>futures</code> framework of Dask. We have a few helper functions: <code>identity</code> to be used as default instance for the mappings between coarse and fine meshes, and <code>pairs</code>, a function that iterates through successive pairs of a list.</p>
<div class="highlight"><span class="filename">parareal/futures.py</span><pre><span></span><code><span class="kn">from</span> <span class="nn">.abstract</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Solution</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">,</span> <span class="n">Vector</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Callable</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">ceil</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy.typing</span> <span class="kn">import</span> <span class="n">NDArray</span>
<span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">Client</span><span class="p">,</span> <span class="n">Future</span>  <span class="c1"># type: ignore</span>
<span class="kn">import</span> <span class="nn">logging</span>


<span class="k">def</span> <span class="nf">identity</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">pairs</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lst</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">lst</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

<span class="o">&lt;&lt;</span><span class="n">parareal</span><span class="o">-</span><span class="n">futures</span><span class="o">&gt;&gt;</span>
</code></pre></div>
<p>We need to send every operation to a remote worker, that includes summing the vectors from coarse and fine integrators.</p>
<div class="highlight"><span class="filename">#parareal-futures</span><pre><span></span><code><span class="k">def</span> <span class="nf">combine</span><span class="p">(</span><span class="n">c1</span><span class="p">:</span> <span class="n">Vector</span><span class="p">,</span> <span class="n">f1</span><span class="p">:</span> <span class="n">Vector</span><span class="p">,</span> <span class="n">c2</span><span class="p">:</span> <span class="n">Vector</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Vector</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">c1</span> <span class="o">+</span> <span class="n">f1</span> <span class="o">-</span> <span class="n">c2</span>
</code></pre></div>
<div class="highlight"><span class="filename">#time-windows</span><pre><span></span><code><span class="k">def</span> <span class="nf">time_windows</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">window_size</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Split the times vector in a set of time windows of a given size.</span>

<span class="sd">    Args:</span>
<span class="sd">        times:          The times vector</span>
<span class="sd">        window_size:    The number of steps per window (note that n steps</span>
<span class="sd">        correspond to n + 1 elements in the window). The last window may</span>
<span class="sd">        be smaller.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_intervals</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_intervals</span> <span class="o">/</span> <span class="n">window_size</span><span class="p">))</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">window_size</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">m</span><span class="p">:</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">m</span><span class="o">+</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">))]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
</code></pre></div>
<p>Every call that actually requires some of the data needs to be sent to the remote worker(s). Where we could get away before with putting everything in a closure, now it is easier to make a class that includes the Dask <code>Client</code> instance.</p>
<div class="highlight"><span class="filename">#parareal-futures</span><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Parareal</span><span class="p">:</span>
    <span class="n">client</span><span class="p">:</span> <span class="n">Client</span>
    <span class="n">coarse</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Solution</span><span class="p">]</span>
    <span class="n">fine</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Solution</span><span class="p">]</span>
    <span class="n">c2f</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">=</span> <span class="n">identity</span>
    <span class="n">f2c</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">=</span> <span class="n">identity</span>

    <span class="k">def</span> <span class="nf">_c2f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Future</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Future</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">c2f</span> <span class="ow">is</span> <span class="n">identity</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c2f</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_f2c</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Future</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Future</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">f2c</span> <span class="ow">is</span> <span class="n">identity</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f2c</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_coarse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_iter</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">Future</span><span class="p">,</span> <span class="n">t0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">t1</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span>  <span class="n">Future</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Coarse run: </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coarse</span><span class="p">(</span><span class="n">n_iter</span><span class="p">),</span> <span class="n">y</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_iter</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">Future</span><span class="p">,</span> <span class="n">t0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">t1</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Future</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Fine run: </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fine</span><span class="p">(</span><span class="n">n_iter</span><span class="p">),</span> <span class="n">y</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>

    <span class="o">&lt;&lt;</span><span class="n">parareal</span><span class="o">-</span><span class="n">methods</span><span class="o">&gt;&gt;</span>
</code></pre></div>
<p>The <code>step</code> method implements the core parareal algorithm.</p>
<div class="highlight"><span class="filename">#parareal-methods</span><pre><span></span><code><span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_iter</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y_prev</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Future</span><span class="p">],</span> <span class="n">t</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Future</span><span class="p">]:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">size</span>
    <span class="n">y_next</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span>
    <span class="n">y_next</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_prev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c2f</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coarse</span><span class="p">(</span><span class="n">n_iter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">f2c</span><span class="p">(</span><span class="n">y_next</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fine</span><span class="p">(</span><span class="n">n_iter</span><span class="p">,</span> <span class="n">y_prev</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c2f</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coarse</span><span class="p">(</span><span class="n">n_iter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">f2c</span><span class="p">(</span><span class="n">y_prev</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">y_next</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">combine</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">y_next</span>
</code></pre></div>
<p>We schedule every possible iteration of parareal as a future. The tactic is to cancel remaining jobs only once we found a converging result. This way, workers can compute next iterations, even if the last step of the previous iteration is not yet complete and tested for convergence.</p>
<div class="highlight"><span class="filename">#parareal-methods</span><pre><span></span><code><span class="k">def</span> <span class="nf">schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_0</span><span class="p">:</span> <span class="n">Vector</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Future</span><span class="p">]]:</span>
    <span class="c1"># schedule initial coarse integration</span>
    <span class="n">y_init</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">y_0</span><span class="p">)]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
        <span class="n">y_init</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coarse</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y_init</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>

    <span class="c1"># schedule all iterations of parareal</span>
    <span class="n">jobs</span> <span class="o">=</span> <span class="p">[</span><span class="n">y_init</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">n_iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)):</span>
        <span class="n">jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">n_iter</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">jobs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">t</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">jobs</span>
</code></pre></div>
<p>The <code>wait</code> method then gathers results and returns the first iteration that satisfies <code>convergence_test</code>.</p>
<div class="highlight"><span class="filename">#parareal-methods</span><pre><span></span><code><span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobs</span><span class="p">,</span> <span class="n">convergence_test</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">jobs</span><span class="p">)):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">jobs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">convergence_test</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">cancel</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
<h2 id="harmonic-oscillator">Harmonic oscillator<a class="headerlink" href="#harmonic-oscillator" title="Permanent link">&para;</a></h2>
<p>We may test this on the harmonic oscillator.</p>
<div class="highlight"><span class="filename">test/test_futures.py</span><pre><span></span><code><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">numpy.typing</span> <span class="kn">import</span> <span class="n">NDArray</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">parareal.futures</span> <span class="kn">import</span> <span class="n">Parareal</span>
<span class="kn">from</span> <span class="nn">parareal.harmonic_oscillator</span> <span class="kn">import</span> <span class="n">harmonic_oscillator</span>
<span class="kn">from</span> <span class="nn">parareal.forward_euler</span> <span class="kn">import</span> <span class="n">forward_euler</span>
<span class="kn">from</span> <span class="nn">parareal.iterate_solution</span> <span class="kn">import</span> <span class="n">iterate_solution</span>
<span class="kn">from</span> <span class="nn">parareal.tabulate_solution</span> <span class="kn">import</span> <span class="n">tabulate</span>

<span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">Client</span>  <span class="c1"># type: ignore</span>


<span class="n">OMEGA0</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">ZETA</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">H</span> <span class="o">=</span> <span class="mf">0.001</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">harmonic_oscillator</span><span class="p">(</span><span class="n">OMEGA0</span><span class="p">,</span> <span class="n">ZETA</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">coarse</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">forward_euler</span><span class="p">(</span><span class="n">system</span><span class="p">)(</span><span class="n">y</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">fine</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">iterate_solution</span><span class="p">(</span><span class="n">forward_euler</span><span class="p">(</span><span class="n">system</span><span class="p">),</span> <span class="n">H</span><span class="p">)(</span><span class="n">y</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">History</span><span class="p">:</span>
    <span class="n">history</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">convergence_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;got result: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_parareal</span><span class="p">():</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">Parareal</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="n">partial</span><span class="p">(</span><span class="n">coarse</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="n">partial</span><span class="p">(</span><span class="n">fine</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">15.0</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
    <span class="n">history</span> <span class="o">=</span> <span class="n">History</span><span class="p">()</span>
    <span class="n">jobs</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">y0</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">jobs</span><span class="p">,</span> <span class="n">history</span><span class="o">.</span><span class="n">convergence_test</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">15.0</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">tabulate</span><span class="p">(</span><span class="n">fine</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>
<h2 id="building-figures">Building figures<a class="headerlink" href="#building-figures" title="Permanent link">&para;</a></h2>
<div class="highlight"><span class="filename">build/Makefile</span><pre><span></span><code><span class="nv">.RECIPEPREFIX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>&gt;

<span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">all</span>

<span class="err">&lt;&lt;make-targets&gt;&gt;</span>

<span class="nf">all</span><span class="o">:</span><span class="w"> </span><span class="k">$(</span><span class="nv">targets</span><span class="k">)</span>
</code></pre></div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["content.code.annotate"], "search": "../assets/javascripts/workers/search.db81ec45.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.4b2c34cd.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
      
    
  </body>
</html>